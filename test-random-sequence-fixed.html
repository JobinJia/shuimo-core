<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Random Sequence - Fixed Version</title>
  <style>
    body {
      font-family: 'Monaco', 'Courier New', monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .section {
      background: #252526;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 3px solid #007acc;
    }
    h2 {
      color: #4ec9b0;
      margin-top: 0;
    }
    .match { color: #4ec9b0; }
    .mismatch { color: #f48771; }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
    .console-log {
      font-size: 12px;
      line-height: 1.6;
    }
    .step {
      margin: 15px 0;
      padding: 10px;
      background: #1e1e1e;
      border-left: 3px solid #ce9178;
    }
  </style>
</head>
<body>
  <h1>üî¨ Random Sequence Test - Fixed Version</h1>
  <p>Testing if SVG version now matches original's random consumption pattern</p>

  <div class="section">
    <h2>Test Seed</h2>
    <pre id="seed-display"></pre>
  </div>

  <div class="section">
    <h2>Original Canvas Version</h2>
    <div id="original-log" class="console-log"></div>
  </div>

  <div class="section">
    <h2>SVG Version (Fixed)</h2>
    <div id="svg-log" class="console-log"></div>
  </div>

  <div class="section">
    <h2>Comparison Result</h2>
    <div id="comparison"></div>
  </div>

  <!-- Load original implementation -->
  <script src="reference-code/flowers/main.js"></script>

  <!-- SVG implementation will be loaded from dev server -->
  <script type="module">
    import { generateFlower } from './packages/core/src/drawing/index.ts'

    const TEST_SEED = 'test-123'
    document.getElementById('seed-display').textContent = TEST_SEED

    // ========================================================================
    // Test Original Version
    // ========================================================================
    console.log('='.repeat(80))
    console.log('TESTING ORIGINAL CANVAS VERSION')
    console.log('='.repeat(80))

    const originalLogs = []
    const originalConsoleLog = console.log
    console.log = function(...args) {
      originalConsoleLog.apply(console, args)
      originalLogs.push(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '))
    }

    // Reset and test original
    Math.seed(TEST_SEED)

    const checkpoints = {
      original: {}
    }

    // Checkpoint 1: After seed
    let r1 = [Math.random(), Math.random(), Math.random()]
    checkpoints.original.afterSeed = r1
    Math.seed(TEST_SEED)

    // Checkpoint 2: After makeBG (simulate)
    paper({ col: [0.98, 0.91, 0.74], tex: 10, spr: 0 })
    let r2 = [Math.random(), Math.random(), Math.random()]
    checkpoints.original.afterBG = r2
    Math.seed(TEST_SEED)

    // Checkpoint 3: After generate paper
    paper({ col: [1, 0.99, 0.9], tex: 20, spr: 1 })
    let r3 = [Math.random(), Math.random(), Math.random()]
    checkpoints.original.afterPaper = r3
    Math.seed(TEST_SEED)

    // Checkpoint 4: Plant type decision
    const plantTypeRandom = Math.random()
    checkpoints.original.plantType = plantTypeRandom
    checkpoints.original.selectedType = plantTypeRandom <= 0.5 ? 'woody' : 'herbal'

    console.log = originalConsoleLog
    document.getElementById('original-log').innerHTML = `
      <div class="step">
        <strong>Step 1: After seed</strong>
        <pre>${JSON.stringify(r1, null, 2)}</pre>
      </div>
      <div class="step">
        <strong>Step 2: After makeBG() paper()</strong>
        <pre>${JSON.stringify(r2, null, 2)}</pre>
      </div>
      <div class="step">
        <strong>Step 3: After generate() paper()</strong>
        <pre>${JSON.stringify(r3, null, 2)}</pre>
      </div>
      <div class="step">
        <strong>Step 4: Plant type decision</strong>
        <pre>Random: ${plantTypeRandom.toFixed(10)}
Selected: ${checkpoints.original.selectedType}</pre>
      </div>
    `

    // ========================================================================
    // Test SVG Version
    // ========================================================================
    console.log('='.repeat(80))
    console.log('TESTING SVG VERSION (FIXED)')
    console.log('='.repeat(80))

    const svgLogs = []
    console.log = function(...args) {
      originalConsoleLog.apply(console, args)
      svgLogs.push(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '))
    }

    try {
      const svg = generateFlower({
        seed: TEST_SEED,
        type: 'random',
        width: 600,
        height: 600,
        background: 'none'
      })

      console.log = originalConsoleLog

      // Extract checkpoints from SVG logs
      const svgCheckpoints = {}
      svgLogs.forEach(log => {
        if (log.includes('[1] After seed')) {
          const match = log.match(/\[(.*?)\]/)
          if (match) svgCheckpoints.afterSeed = JSON.parse(match[1])
        }
        else if (log.includes('[2] After makeBG')) {
          const match = log.match(/\[(.*?)\]/)
          if (match) svgCheckpoints.afterBG = JSON.parse(match[1])
        }
        else if (log.includes('[3] After generate')) {
          const match = log.match(/\[(.*?)\]/)
          if (match) svgCheckpoints.afterPaper = JSON.parse(match[1])
        }
        else if (log.includes('[4] Plant type decision')) {
          const match = log.match(/random: ([\d.]+)/)
          if (match) {
            svgCheckpoints.plantType = parseFloat(match[1])
            svgCheckpoints.selectedType = log.includes('woody') ? 'woody' : 'herbal'
          }
        }
      })

      document.getElementById('svg-log').innerHTML = svgLogs.map(log => `<div>${log}</div>`).join('')

      // ========================================================================
      // Compare Results
      // ========================================================================
      const compare = (label, orig, svg) => {
        if (Array.isArray(orig)) {
          const match = orig.every((v, i) => Math.abs(v - svg[i]) < 1e-10)
          return `
            <div class="step">
              <strong>${label}</strong>
              <pre>Original: ${JSON.stringify(orig, null, 2)}
SVG:      ${JSON.stringify(svg, null, 2)}
<span class="${match ? 'match' : 'mismatch'}">${match ? '‚úÖ MATCH' : '‚ùå MISMATCH'}</span></pre>
            </div>
          `
        } else {
          const match = Math.abs(orig - svg) < 1e-10
          return `
            <div class="step">
              <strong>${label}</strong>
              <pre>Original: ${orig}
SVG:      ${svg}
<span class="${match ? 'match' : 'mismatch'}">${match ? '‚úÖ MATCH' : '‚ùå MISMATCH'}</span></pre>
            </div>
          `
        }
      }

      document.getElementById('comparison').innerHTML = `
        ${compare('Step 1: After seed', checkpoints.original.afterSeed, svgCheckpoints.afterSeed)}
        ${compare('Step 2: After makeBG()', checkpoints.original.afterBG, svgCheckpoints.afterBG)}
        ${compare('Step 3: After generate() paper', checkpoints.original.afterPaper, svgCheckpoints.afterPaper)}
        ${compare('Step 4: Plant type random', checkpoints.original.plantType, svgCheckpoints.plantType)}
        <div class="step">
          <strong>Selected Plant Type</strong>
          <pre>Original: ${checkpoints.original.selectedType}
SVG:      ${svgCheckpoints.selectedType}
<span class="${checkpoints.original.selectedType === svgCheckpoints.selectedType ? 'match' : 'mismatch'}">${checkpoints.original.selectedType === svgCheckpoints.selectedType ? '‚úÖ MATCH' : '‚ùå MISMATCH'}</span></pre>
        </div>
      `

    } catch (error) {
      console.log = originalConsoleLog
      document.getElementById('svg-log').innerHTML = `<div class="mismatch">Error: ${error.message}</div><pre>${error.stack}</pre>`
      document.getElementById('comparison').innerHTML = `<div class="mismatch">‚ùå SVG generation failed</div>`
    }
  </script>
</body>
</html>
